<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>√çm√£ Insano - Fases</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #restartBtn {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        font-size: 16px;
        display: none;
      }
    </style>
  </head>
  <body>
    <button id="restartBtn">Pr√≥xima Fase</button>

    <script>
      let ball, magnet, portal, polarity = 1;
      let walls = [];
      let particles = [];
      let timeLeft = 30;
      let startTime;
      let gameWon = false;
      let gameOverFlag = false;
      let level = 1;

      let winSound, loseSound;

      function preload() {
        winSound = loadSound('https://cdn.jsdelivr.net/gh/jonobr1/Neuronal-Synchrony/audio/chaos-loop.mp3');
        loseSound = loadSound('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
      }

      function setup() {
        createCanvas(windowWidth, windowHeight);
        setupLevel();
        document.getElementById("restartBtn").onclick = nextLevel;
      }

      function setupLevel() {
        ball = createVector(100, height / 2);
        ball.vel = createVector(0, 0);
        magnet = createVector(mouseX, mouseY);
        portal = createVector(width - 100, random(100, height - 100));

        walls = [];
        particles = [];
        for (let i = 0; i < 5 + level; i++) {
          walls.push({
            x: random(width * 0.3, width * 0.8),
            y: random(50, height - 50),
            w: random(80, 150),
            h: 20
          });
        }

        startTime = millis();
        timeLeft = 30;
        gameWon = false;
        gameOverFlag = false;
        document.getElementById("restartBtn").style.display = "none";
        loop();
      }

      function draw() {
        background(30);

        let elapsed = (millis() - startTime) / 1000;
        timeLeft = max(0, 30 - elapsed);

        if (timeLeft === 0 && !gameWon && !gameOverFlag) {
          triggerGameOver();
        }

        // Portal
        fill(0, 200, 255);
        ellipse(portal.x, portal.y, 40);

        // Magnet
        magnet.set(mouseX, mouseY);
        fill(polarity === 1 ? 'red' : 'blue');
        ellipse(magnet.x, magnet.y, 30);

        // Force and movement
        let force = p5.Vector.sub(magnet, ball);
        let distSq = constrain(force.magSq(), 100, 10000);
        force.setMag(polarity * 1000 / distSq);
        ball.vel.add(force);
        ball.vel.limit(7);
        ball.add(ball.vel);

        // Border collision
        if (ball.x < 0 || ball.x > width) ball.vel.x *= -1;
        if (ball.y < 0 || ball.y > height) ball.vel.y *= -1;

        // Walls
        fill(255);
        for (let w of walls) {
          rect(w.x, w.y, w.w, w.h);
          if (ball.x > w.x && ball.x < w.x + w.w && ball.y > w.y && ball.y < w.y + w.h) {
            ball.vel.mult(-0.8);
          }
        }

        // Ball
        fill(255, 255, 100);
        ellipse(ball.x, ball.y, 20);

        // Win condition
        if (ball.dist(portal) < 25 && !gameWon) {
          triggerWin();
        }

        // Timer
        fill(255);
        textSize(18);
        text(`Fase: ${level}`, 20, 25);
        text(`Tempo restante: ${timeLeft.toFixed(1)}s`, 20, 50);
        text("Clique para inverter o √≠m√£ (Atra√ß√£o/Rejei√ß√£o)", 20, 75);

        // Particle effects
        for (let p of particles) {
          p.update();
          p.display();
        }

        particles = particles.filter(p => p.lifespan > 0);
      }

      function mousePressed() {
        if (!gameWon && !gameOverFlag) polarity *= -1;
      }

      function triggerWin() {
        gameWon = true;
        winSound.play();
        for (let i = 0; i < 100; i++) {
          particles.push(new Particle(ball.x, ball.y));
        }
        fill(0, 255, 0);
        textSize(40);
        textAlign(CENTER, CENTER);
        text("üéâ Voc√™ venceu!", width / 2, height / 2);
        noLoop();
        document.getElementById("restartBtn").innerText = "Pr√≥xima Fase";
        document.getElementById("restartBtn").style.display = "block";
      }

      function triggerGameOver() {
        gameOverFlag = true;
        loseSound.play();
        fill(255, 0, 0);
        textSize(40);
        textAlign(CENTER, CENTER);
        text("üíÄ Tempo esgotado!", width / 2, height / 2);
        noLoop();
        document.getElementById("restartBtn").innerText = "Tentar Novamente";
        document.getElementById("restartBtn").style.display = "block";
      }

      function nextLevel() {
        if (gameWon) level++;
        setupLevel();
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
      }

      class Particle {
        constructor(x, y) {
          this.pos = createVector(x, y);
          this.vel = p5.Vector.random2D().mult(random(1, 5));
          this.lifespan = 255;
        }

        update() {
          this.pos.add(this.vel);
          this.lifespan -= 4;
        }

        display() {
          noStroke();
          fill(255, this.lifespan);
          ellipse(this.pos.x, this.pos.y, 5);
        }
      }
    </script>
  </body>
</html>
